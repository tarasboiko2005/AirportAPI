services:
  # 1. Бекенд (Django/ASGI)
  - type: web
    name: airport-backend
    env: python
    autoDeploy: true
    # Шлях до requirements у корені, але команди через папку aviation
    buildCommand: |
      pip install -r requirements.txt
      python aviation/manage.py migrate
      python aviation/manage.py collectstatic --noinput
    startCommand: uvicorn aviation.asgi:application --app-dir aviation --host 0.0.0.0 --port $PORT
    envVars:
      - key: SECRET_KEY
        generateValue: true
      - key: DEBUG
        value: False
      - key: DJANGO_ALLOWED_HOSTS
        value: airport-backend.onrender.com
      - key: CSRF_TRUSTED_ORIGINS
        value: https://airport-backend.onrender.com
      - key: CORS_ALLOWED_ORIGINS
        value: https://airport-ui.onrender.com  # URL твого майбутнього фронтенду
      - key: DATABASE_URL
        fromService:
          name: airport-db
          type: postgresql
      - key: REDIS_URL
        fromService:
          name: airport-redis
          type: redis
      # Інші твої змінні (Stripe, Gemini, Email) залишаються тут...

  # 2. Фронтенд (React/Vite)
  - type: static
    name: airport-ui
    env: static
    rootDir: airport-ui  # Render перейде в цю папку перед збіркою
    buildCommand: npm install && npm run build
    publishPath: dist    # Папка, яку створює Vite після build
    envVars:
      - key: VITE_API_BASE_URL
        value: https://airport-backend.onrender.com

  # 3. Celery Worker
  - type: worker
    name: airport-celery
    env: python
    buildCommand: pip install -r requirements.txt
    startCommand: celery -A aviation worker -l info --workdir aviation
    envVars:
      - key: DATABASE_URL
        fromService:
          name: airport-db
          type: postgresql
      - key: REDIS_URL
        fromService:
          name: airport-redis
          type: redis

  # 4. Redis
  - type: redis
    name: airport-redis
    ipAllowList: []

# 5. PostgreSQL
databases:
  - name: airport-db
    plan: free